<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel do Comprador · NX Boats</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    body{background:linear-gradient(180deg,#fff, #f7f7f8);}
    .app-header{backdrop-filter:saturate(120%) blur(6px);}
    .kpi .icon{
      width:36px;height:36px;border-radius:.75rem;
      display:flex;align-items:center;justify-content:center;
    }
    .table thead th{font-weight:600;}
    /* Chat */
    .chat-box{height:58vh; overflow-y:auto; background:#fafafa; border:1px solid #e9ecef; border-radius:.75rem; padding:1rem;}
    .bubble{max-width:75%; padding:.5rem .75rem; border-radius:.75rem; word-wrap:break-word; white-space:pre-wrap;}
    .bubble-user{background:#0d6efd;color:#fff;}
    .bubble-ai{background:#f1f3f5;color:#212529;}
    .nav-tabs .nav-link{border:0;}
    .nav-tabs .nav-link.active{border-bottom:2px solid #0d6efd; font-weight:600;}
    .card-radius{border-radius:1rem;}
  </style>
</head>
<body>

<!-- ========================= HEADER ========================= -->
<header class="app-header border-bottom bg-white sticky-top">
  <div class="container-xxl py-3 d-flex align-items-center justify-content-between">
    <div class="d-flex align-items-center gap-3">
      <div class="rounded-circle bg-dark" style="width:32px;height:32px"></div>
      <h1 class="h5 m-0 fw-semibold">NX Boats · Painel do Comprador</h1>
    </div>
    <span class="badge text-bg-secondary">Mockup visual</span>
  </div>
</header>

<!-- ========================= TABS =========================== -->
<div class="container-xxl mt-3">
  <ul class="nav nav-tabs gap-2" id="mainTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-home" data-bs-toggle="tab" data-bs-target="#pane-home" type="button" role="tab">
        <i class="fa-solid fa-table-columns me-2"></i>Início
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-pedidos" data-bs-toggle="tab" data-bs-target="#pane-pedidos" type="button" role="tab">
        <i class="fa-solid fa-cart-shopping me-2"></i>Produtos Criticos
      </button>
    </li>
     </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-pedidos" data-bs-toggle="tab" data-bs-target="#pane-pedidos" type="button" role="tab">
        <i class="fa-solid fa-cart-shopping me-2"></i>Pedidos
      </button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-chat" data-bs-toggle="tab" data-bs-target="#pane-chat" type="button" role="tab">
        <i class="fa-solid fa-comments me-2"></i>Chat IA
      </button>
    </li>
    <div class="ms-auto d-flex align-items-center gap-2">
      <label class="form-label m-0 small text-muted">Comprador</label>
      <input id="compradorInput" class="form-control form-control-sm" style="width:120px" placeholder="Ex.: CARLA" value="CARLA">
      <button id="aplicarComprador" class="btn btn-sm btn-outline-secondary">Aplicar</button>
      <button id="btnRefresh" class="btn btn-sm btn-primary"><i class="fa-solid fa-rotate me-1"></i>Atualizar</button>
    </div>
  </ul>
</div>

<div class="container-xxl tab-content mt-4">

  <!-- ========================= HOME ========================= -->
  <div class="tab-pane fade show active" id="pane-home" role="tabpanel" aria-labelledby="tab-home">
    <!-- KPIs -->
    <div class="row g-3">
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Itens críticos</div>
              <div id="kpi-itens-criticos" class="h4 m-0">—</div>
              <div class="small text-muted">Estoque abaixo da cobertura</div>
            </div>
            <div class="icon bg-warning-subtle text-warning"><i class="fa-solid fa-triangle-exclamation"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Pedidos pendentes</div>
              <div id="kpi-pedidos-pendentes" class="h4 m-0">—</div>
              <div class="small text-muted">Aguardando entrega</div>
            </div>
            <div class="icon bg-primary-subtle text-primary"><i class="fa-solid fa-cart-flatbed"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Cotações abertas</div>
              <div id="kpi-cotacoes" class="h4 m-0">—</div>
              <div class="small text-muted">Responder hoje</div>
            </div>
            <div class="icon bg-secondary-subtle text-secondary"><i class="fa-solid fa-list-check"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Gastos do mês</div>
              <div id="kpi-gastos" class="h4 m-0">—</div>
              <div class="small text-muted">Capex + Opex</div>
            </div>
            <div class="icon bg-success-subtle text-success"><i class="fa-solid fa-dollar-sign"></i></div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Savings do mês</div>
              <div id="kpi-savings" class="h4 m-0">—</div>
            </div>
            <div class="icon bg-success-subtle text-success"><i class="fa-solid fa-piggy-bank"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Prazo médio</div>
              <div id="kpi-prazo" class="h4 m-0">—</div>
            </div>
            <div class="icon bg-info-subtle text-info"><i class="fa-solid fa-calendar-check"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Fill rate</div>
              <div id="kpi-fillrate" class="h4 m-0">—</div>
            </div>
            <div class="icon bg-dark-subtle text-dark"><i class="fa-solid fa-gauge-simple-high"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-6 col-xl-3">
        <div class="card card-radius shadow-sm kpi">
          <div class="card-body d-flex justify-content-between">
            <div>
              <div class="text-uppercase small text-muted fw-semibold">Atraso médio</div>
              <div id="kpi-atraso" class="h4 m-0">—</div>
            </div>
            <div class="icon bg-danger-subtle text-danger"><i class="fa-solid fa-clock-rotate-left"></i></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gráficos -->
    <div class="row g-3 mt-1">
      <div class="col-12 col-xl-6">
        <div class="card card-radius shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Gastos por mês</h6>
            <canvas id="chartGastos" height="220"></canvas>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-6">
        <div class="card card-radius shadow-sm">
          <div class="card-body">
            <h6 class="fw-semibold mb-3">Savings por mês</h6>
            <canvas id="chartSavings" height="220"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ======================== PEDIDOS ======================= -->
  <div class="tab-pane fade" id="pane-pedidos" role="tabpanel" aria-labelledby="tab-pedidos">
    <div class="card card-radius shadow-sm">
      <div class="card-body">
        <div class="d-flex flex-wrap gap-2 align-items-center">
          <div class="input-group" style="max-width:380px">
            <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
            <input id="buscaPedidos" class="form-control" placeholder="Buscar por nº, fornecedor ou CNPJ"/>
          </div>

          <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
              <i class="fa-solid fa-filter me-1"></i>Status
            </button>
            <ul class="dropdown-menu" id="statusMenu">
              <li><a class="dropdown-item active" data-status="TODOS" href="#">Todos</a></li>
              <li><a class="dropdown-item" data-status="EM_ABERTO" href="#">Em aberto</a></li>
              <li><a class="dropdown-item" data-status="ATRASADO" href="#">Atrasado</a></li>
              <li><a class="dropdown-item" data-status="RECEBIDO" href="#">Recebido</a></li>
            </ul>
          </div>

          <div class="ms-auto d-flex gap-2">
            <button id="btnExport" class="btn btn-outline-secondary"><i class="fa-solid fa-file-arrow-down me-1"></i>Exportar CSV</button>
          </div>
        </div>

        <div class="table-responsive mt-3">
          <table class="table align-middle">
            <thead class="table-light">
              <tr>
                <th>Pedido</th><th>Fornecedor</th><th>Emissão</th><th>Previsão</th><th class="text-end">Total</th><th>Status</th><th class="text-end">Atraso</th><th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody id="tbodyPedidos"></tbody>
          </table>
        </div>

        <div id="vazioPedidos" class="text-center text-muted small py-4 d-none">Nenhum pedido encontrado com os filtros atuais.</div>
      </div>
    </div>
  </div>
<!-- ========================= CHAT ========================= -->
<div class="tab-pane fade" id="pane-chat" role="tabpanel" aria-labelledby="tab-chat">
  <div class="row g-3">
    <div class="col-12 col-xl-8">
      <div class="card card-radius shadow-sm">
        <div class="card-body">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <h6 class="fw-semibold m-0"><i class="fa-solid fa-robot me-2"></i>NXCopilot · Compras</h6>
            <div class="d-flex align-items-center gap-2">
              <span class="badge text-bg-light">Comprador: <strong id="ctxComprador">—</strong></span>
              <div class="d-flex align-items-center gap-1">
                <input id="userSankhya" class="form-control form-control-sm" style="width:120px" placeholder="Usuário"/>
                <input id="passSankhya" type="password" class="form-control form-control-sm" style="width:120px" placeholder="Senha"/>
                <div class="form-check ms-1">
                  <input class="form-check-input" type="checkbox" id="rememberCreds">
                  <label class="form-check-label small text-muted" for="rememberCreds">lembrar</label>
                </div>
                <button id="btnSaveCreds" class="btn btn-sm btn-outline-secondary"><i class="fa-solid fa-key me-1"></i>Salvar</button>
              </div>
            </div>
          </div>

          <!-- Comandos rápidos -->
          <div class="alert alert-light border d-flex flex-wrap align-items-center gap-2 py-2">
            <span class="small text-muted me-2"><i class="fa-solid fa-terminal me-1"></i>Comandos:</span>
            <code class="small">/necessidades</code>
            <code class="small">/criticos</code>
            <code class="small">/status PRO-001</code>
            <code class="small">/atrasados</code>
            <code class="small">/abertos</code>
            <code class="small">/recebidos</code>
            <code class="small">/itens 101567</code>
            <code class="small">/previsao 101234 10/09/2025</code>
            <span class="small text-muted ms-auto">Enter = enviar · Shift+Enter = nova linha</span>
          </div>

          <div id="chatBox" class="chat-box mb-3"></div>

          <div class="input-group">
            <textarea id="chatInput" rows="1" class="form-control" placeholder="Ex.: /necessidades ou 'itens críticos do meu portfólio'"></textarea>
            <button id="btnSendChat" class="btn btn-primary">
              <span class="d-inline-flex align-items-center"><i class="fa-solid fa-paper-plane me-1"></i>Enviar</span>
            </button>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-2">
            <button class="btn btn-outline-secondary btn-sm suggestion">/necessidades</button>
            <button class="btn btn-outline-secondary btn-sm suggestion">/criticos</button>
            <button class="btn btn-outline-secondary btn-sm suggestion">/atrasados</button>
            <button class="btn btn-outline-secondary btn-sm suggestion">/itens 101567</button>
          </div>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-4">
      <div class="card card-radius shadow-sm">
        <div class="card-body">
          <h6 class="fw-semibold mb-3">Dicas rápidas</h6>
          <ul class="small m-0">
            <li>Use <strong>comprador=<span class="ctxComprador">CARLA</span></strong> para filtrar.</li>
            <li><em>“necessidades de compra”</em> mostra sugestão de reposição.</li>
            <li><em>“itens críticos”</em> = cobertura &lt; lead time.</li>
            <li><em>“pedidos atrasados”</em> lista POs vencidos.</li>
            <li><em>“itens do pedido #101567”</em> abre os itens.</li>
            <li><em>“alterar previsão do #101234 para 10/09/2025”</em> pede confirmação.</li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ======================= MODAL DETALHES =================== -->
<div class="modal fade" id="modalDetalhes" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title" id="detalhesTitulo">Pedido</h6>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="detalhesBody"></div>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* ============================================================
   MOCKS (substituir por chamadas reais ao backend / Sankhya)
   ============================================================ */
const MOCK_PEDIDOS = [
  { nunota:101234, fornecedor:"Náutica Brava Ltda", cnpj:"12.345.678/0001-99", emissao:"2025-08-20", previsao:"2025-09-05", total:58230.45, status:"EM_ABERTO", top:"CP", comprador:"CARLA",
    itens:[{cod:"PRO-001", desc:"Gelcoat Branco 18kg", qtd:12, un:"BAL", vlr:860, critico:true},{cod:"PRO-882", desc:"Fibra 450g/m² rolo", qtd:40, un:"ROL", vlr:210.5}]},
  { nunota:101567, fornecedor:"Brasil Resinas", cnpj:"98.765.432/0001-77", emissao:"2025-08-10", previsao:"2025-08-22", total:32780, status:"ATRASADO", top:"CP", comprador:"CARLA",
    itens:[{cod:"PRO-777", desc:"Resina Isophtálica 200kg", qtd:4, un:"TAM", vlr:4920, critico:true}]},
  { nunota:101890, fornecedor:"Aços & Metais Nordeste", cnpj:"01.222.333/0001-55", emissao:"2025-08-18", previsao:"2025-08-29", total:9120.7, status:"RECEBIDO", top:"CP", comprador:"CARLA",
    itens:[{cod:"PRO-900", desc:"Chapa Inox 304 1mm", qtd:30, un:"UN", vlr:210}]},
  { nunota:102004, fornecedor:"Eletrônica Náutica Prime", cnpj:"45.987.111/0001-22", emissao:"2025-08-24", previsao:"2025-09-10", total:145230, status:"EM_ABERTO", top:"CP", comprador:"CARLA",
    itens:[{cod:"PRO-120", desc:"GPS Chartplotter 9''", qtd:6, un:"UN", vlr:8200},{cod:"PRO-121", desc:"Sonda Transdutor", qtd:6, un:"UN", vlr:2100}]},
];

const MOCK_KPIS = {
  itensCriticos: 14, pedidosPendentes: 8, cotacoesAbertas: 5,
  gastosMes: 482000, savingsMes: 32750, prazoMedioEntrega: 17.2, fillRate: 93.4, atrasosMediosDias: 4.1
};

const MOCK_SERIES = Array.from({length:12}).map((_,i)=>({
  mes: new Date(2025,i,1).toLocaleDateString('pt-BR',{month:'short'}),
  valor: 200000 + Math.round(Math.random()*180000),
  savings: 15000 + Math.round(Math.random()*25000),
}));

/* ========================== Utils ========================== */
const fmtBRL = n => (isNaN(n)?'—': n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'}));
const dias = (a,b)=> Math.round(Math.abs(new Date(a)-new Date(b))/86400000);

/* ========================== Estado ========================= */
let COMPRADOR = localStorage.getItem('comprador') || 'CARLA';
document.getElementById('compradorInput').value = COMPRADOR;

/* ========================== KPIs =========================== */
function preencherKPIs(k){
  document.getElementById('kpi-itens-criticos').textContent = k.itensCriticos;
  document.getElementById('kpi-pedidos-pendentes').textContent = k.pedidosPendentes;
  document.getElementById('kpi-cotacoes').textContent = k.cotacoesAbertas;
  document.getElementById('kpi-gastos').textContent = fmtBRL(k.gastosMes);
  document.getElementById('kpi-savings').textContent = fmtBRL(k.savingsMes);
  document.getElementById('kpi-prazo').textContent = `${k.prazoMedioEntrega} dias`;
  document.getElementById('kpi-fillrate').textContent = `${k.fillRate.toFixed(1)}%`;
  document.getElementById('kpi-atraso').textContent = `${k.atrasosMediosDias} dias`;
}

/* ========================= Gráficos ======================== */
let chartGastos, chartSavings;
function renderCharts(series){
  const ctx1=document.getElementById('chartGastos');
  const ctx2=document.getElementById('chartSavings');

  chartGastos?.destroy(); chartSavings?.destroy();

  chartGastos=new Chart(ctx1,{type:'bar',
    data:{labels:series.map(s=>s.mes),datasets:[{label:'Compras',data:series.map(s=>s.valor)}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'R$ '+v}}}}
  });

  chartSavings=new Chart(ctx2,{type:'line',
    data:{labels:series.map(s=>s.mes),datasets:[{label:'Savings',data:series.map(s=>s.savings), tension:.35}]},
    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{ticks:{callback:v=>'R$ '+v}}}}
  });
}

/* ========================= Pedidos ========================= */
let STATUS_ATUAL='TODOS', BUSCA='';
const tbodyPedidos=document.getElementById('tbodyPedidos');
const vazioPedidos=document.getElementById('vazioPedidos');

function renderPedidos(){
  const lista = MOCK_PEDIDOS
    .filter(p => (COMPRADOR? p.comprador===COMPRADOR : true))
    .filter(p => STATUS_ATUAL==='TODOS' ? true : p.status===STATUS_ATUAL)
    .filter(p => {
      const q=BUSCA.trim().toLowerCase();
      if(!q) return true;
      return String(p.nunota).includes(q) || p.fornecedor.toLowerCase().includes(q) || (p.cnpj||'').toLowerCase().includes(q);
    });

  tbodyPedidos.innerHTML='';
  lista.forEach(p=>{
    const atraso = p.status==='ATRASADO' ? `<span class="text-danger fw-semibold">${dias(p.previsao, new Date())}d</span>` : '—';
    const badge = p.status==='ATRASADO' ? 'bg-danger-subtle text-danger' : (p.status==='EM_ABERTO' ? 'bg-secondary-subtle text-secondary' : 'bg-success-subtle text-success');
    tbodyPedidos.insertAdjacentHTML('beforeend', `
      <tr>
        <td>#${p.nunota}</td>
        <td><div class="fw-semibold">${p.fornecedor}</div><div class="small text-muted">${p.cnpj}</div></td>
        <td>${new Date(p.emissao).toLocaleDateString()}</td>
        <td>${new Date(p.previsao).toLocaleDateString()}</td>
        <td class="text-end">${fmtBRL(p.total)}</td>
        <td><span class="badge ${badge}">${p.status.replace('_',' ')}</span></td>
        <td class="text-end">${atraso}</td>
        <td class="text-end"><button class="btn btn-sm btn-outline-secondary" onclick="abrirDetalhes(${p.nunota})">Detalhes</button></td>
      </tr>
    `);
  });

  vazioPedidos.classList.toggle('d-none', lista.length>0);
}

function abrirDetalhes(nunota){
  const p = MOCK_PEDIDOS.find(x=>x.nunota===nunota);
  if(!p) return;
  document.getElementById('detalhesTitulo').textContent = `Pedido #${p.nunota} · ${p.fornecedor}`;
  const tbody = p.itens.map(i=>`
    <tr>
      <td>${i.cod}</td><td>${i.desc}</td>
      <td class="text-end">${i.qtd}</td><td>${i.un}</td>
      <td class="text-end">${fmtBRL(i.vlr)}</td>
      <td class="text-center">${i.critico?'<span class="badge text-bg-danger">Sim</span>':'<span class="badge text-bg-secondary">Não</span>'}</td>
    </tr>`).join('');
  document.getElementById('detalhesBody').innerHTML = `
    <div class="d-flex flex-wrap gap-2 mb-2">
      <span class="badge text-bg-light">TOP: ${p.top}</span>
      <span class="badge text-bg-light">Comprador: ${p.comprador}</span>
      <span class="badge text-bg-light">CNPJ: ${p.cnpj}</span>
    </div>
    <div class="table-responsive border rounded">
      <table class="table table-sm m-0">
        <thead class="table-light"><tr><th>Código</th><th>Descrição</th><th class="text-end">Qtd</th><th>Un</th><th class="text-end">Valor</th><th class="text-center">Crítico</th></tr></thead>
        <tbody>${tbody}</tbody>
      </table>
    </div>
    <div class="d-flex justify-content-between mt-2 small text-muted">
      <div>Emissão: ${new Date(p.emissao).toLocaleDateString()} · Previsão: ${new Date(p.previsao).toLocaleDateString()}</div>
      <div class="fw-semibold">Total: ${fmtBRL(p.total)}</div>
    </div>`;
  new bootstrap.Modal('#modalDetalhes').show();
}

/* Export CSV */
document.getElementById('btnExport').addEventListener('click', ()=>{
  const rows = [['nunota','fornecedor','cnpj','emissao','previsao','total','status','top','comprador','dias_atraso']];
  MOCK_PEDIDOS.forEach(p=>{
    const atraso = p.status==='ATRASADO' ? dias(p.previsao, new Date()) : 0;
    rows.push([p.nunota,p.fornecedor,p.cnpj,p.emissao,p.previsao,p.total,p.status,p.top,p.comprador,atraso]);
  });
  const csv = rows.map(r=>r.join(';')).join('\n');
  const blob = new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob);
  a.download = `pedidos_${new Date().toISOString().slice(0,10)}.csv`; a.click(); URL.revokeObjectURL(a.href);
});

/* Filtros Pedidos */
document.getElementById('buscaPedidos').addEventListener('input', e=>{BUSCA=e.target.value; renderPedidos();});
document.getElementById('statusMenu').addEventListener('click', e=>{
  if(e.target.matches('.dropdown-item')){
    e.preventDefault();
    document.querySelectorAll('#statusMenu .dropdown-item').forEach(a=>a.classList.remove('active'));
    e.target.classList.add('active');
    STATUS_ATUAL = e.target.dataset.status;
    renderPedidos();
  }
});

/* =========================== Chat ========================== */
const chatBox   = document.getElementById('chatBox');
const chatInput = document.getElementById('chatInput');
const btnSend   = document.getElementById('btnSendChat');
const ctxCompr  = document.getElementById('ctxComprador');

// Credenciais
const userInp = document.getElementById('userSankhya');
const passInp = document.getElementById('passSankhya');
const remember = document.getElementById('rememberCreds');
const btnSaveCreds = document.getElementById('btnSaveCreds');

const LS_USER = 'nx_user';
const LS_REM  = 'nx_remember';

// carrega comprador e credenciais
function syncCtx(){
  ctxCompr.textContent = COMPRADOR;
  document.querySelectorAll('.ctxComprador').forEach(el=> el.textContent = COMPRADOR);
}
syncCtx();

(function loadCreds(){
  const u = localStorage.getItem(LS_USER) || '';
  const r = localStorage.getItem(LS_REM) === '1';
  if (r) {
    userInp.value = u;
    // por segurança não persistimos a senha; o usuário deve digitar a cada sessão
    remember.checked = true;
  }
})();

btnSaveCreds.addEventListener('click', ()=>{
  const u = userInp.value.trim();
  const r = remember.checked;
  if (r && !u) { alert('Informe o usuário para lembrar.'); return; }
  if (r) {
    localStorage.setItem(LS_USER, u);
    localStorage.setItem(LS_REM, '1');
  } else {
    localStorage.removeItem(LS_USER);
    localStorage.removeItem(LS_REM);
  }
  makeBubble('assistant', `Credenciais atualizadas. ${r ? 'Usuário lembrado (senha não é salva).' : 'Não vou lembrar credenciais.'}`);
});

// histórico
let history = [];

// ===== helpers UI =====
function nl2br(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>'); }
function nowHHMM(){ const d=new Date(); return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'}); }

function makeBubble(role, htmlOrText){
  const row = document.createElement('div');
  row.className = role==='user' ? 'd-flex justify-content-end mb-2' : 'd-flex justify-content-start mb-2';

  const wrap = document.createElement('div');
  wrap.className = 'd-flex flex-column align-items-' + (role==='user'?'end':'start');
  row.appendChild(wrap);

  const bubble = document.createElement('div');
  bubble.className = 'bubble ' + (role==='user' ? 'bubble-user' : 'bubble-ai');
  if (typeof htmlOrText === 'string') bubble.innerHTML = nl2br(htmlOrText);
  else bubble.appendChild(htmlOrText);
  wrap.appendChild(bubble);

  if (role === 'assistant') {
    const tools = document.createElement('div');
    tools.className = 'bubble-tools mt-1';
    tools.innerHTML = `
      <button class="btn btn-outline-secondary btn-sm" title="Copiar"><i class="fa-regular fa-copy"></i></button>
      <span class="msg-time">${nowHHMM()}</span>
    `;
    tools.querySelector('button').addEventListener('click', ()=>{
      navigator.clipboard.writeText(bubble.textContent || '');
      tools.querySelector('button').innerHTML = '<i class="fa-solid fa-check"></i>';
      setTimeout(()=> tools.querySelector('button').innerHTML = '<i class="fa-regular fa-copy"></i>', 1200);
    });
    wrap.appendChild(tools);
  }

  chatBox.appendChild(row);
  chatBox.scrollTop = chatBox.scrollHeight;
  return row;
}

function makeLoading(){
  const row = makeBubble('assistant', `
    <span class="loader-dots"><span></span><span></span><span></span></span> Digitando…
  `);
  row.dataset.loading = '1';
  return row;
}

function tableFromData(data){
  const t=document.createElement('table'); t.className='table table-sm table-striped mb-0';
  const thead=document.createElement('thead'); const trh=document.createElement('tr');
  (data.columns||[]).forEach(c=>{const th=document.createElement('th'); th.textContent=c; trh.appendChild(th);});
  thead.appendChild(trh); const tbody=document.createElement('tbody');
  (data.rows||[]).forEach(r=>{const tr=document.createElement('tr'); r.forEach(c=>{const td=document.createElement('td'); td.textContent=c; tr.appendChild(td)}); tbody.appendChild(tr);});
  t.appendChild(thead); t.appendChild(tbody);

  // toolbar export CSV
  const wrap = document.createElement('div');
  const bar = document.createElement('div');
  bar.className = 'd-flex justify-content-end mb-2';
  const btn = document.createElement('button');
  btn.className = 'btn btn-outline-secondary btn-sm';
  btn.innerHTML = '<i class="fa-solid fa-file-arrow-down me-1"></i>Exportar CSV';
  btn.addEventListener('click', ()=>{
    const rows = [data.columns, ...data.rows];
    const csv = rows.map(r=> r.map(v=> String(v).replaceAll(';', ',')).join(';')).join('\n');
    const blob = new Blob(["\uFEFF"+csv],{type:"text/csv;charset=utf-8;"}); const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download=`chat_table_${new Date().toISOString().slice(0,10)}.csv`;
    a.click(); URL.revokeObjectURL(a.href);
  });
  bar.appendChild(btn);
  wrap.appendChild(bar);
  wrap.appendChild(t);
  return wrap;
}

function chartFromSeries(series){
  // cria um canvas e desenha (line) com Chart.js já carregado
  const wrap = document.createElement('div');
  const canvas = document.createElement('canvas');
  canvas.height = 180;
  wrap.appendChild(canvas);
  setTimeout(()=>{
    new Chart(canvas, {
      type: 'line',
      data: { labels: series.map(s=>s.mes), datasets: [{ label:'Série', data: series.map(s=>s.valor), tension:.35 }] },
      options: { responsive:true, plugins:{ legend:{ display:false } } }
    });
  }, 0);
  return wrap;
}

// ===== slash commands focados em compras =====
// /necessidades  | /criticos | /status PRO-001
// /atrasados     | /abertos  | /recebidos
// /itens 101567  | /previsao 101567 10/09/2025
function parseSlashCommand(text){
  const s = text.trim();
  if (!s.startsWith('/')) return null;
  const parts = s.split(/\s+/);
  const cmd = parts[0].toLowerCase();

  if (cmd === '/necessidades') return 'necessidades de compra';
  if (cmd === '/criticos') return 'itens críticos do meu portfólio';
  if (cmd === '/status' && parts[1]) return `status do item ${parts[1]}`;
  if (cmd === '/atrasados') return 'pedidos atrasados';
  if (cmd === '/abertos') return 'pedidos abertos';
  if (cmd === '/recebidos') return 'pedidos recebidos';
  if (cmd === '/itens' && parts[1]) return `itens do pedido #${parts[1].replace(/\D/g,'')}`;
  if (cmd === '/previsao' && parts[1] && parts[2]) return `alterar previsão do #${parts[1].replace(/\D/g,'')} para ${parts[2]}`;
  return null;
}

function requiredCreds(){
  const usuario = userInp.value.trim();
  const senha   = passInp.value;
  if(!usuario || !senha){
    makeBubble('assistant', 'Informe <strong>usuário e senha</strong> do Sankhya (campo no topo do chat).');
    return null;
  }
  return { usuario, senha };
}

// ===== envio principal =====
async function sendChat(text){
  const raw = (text ?? chatInput.value).trim();
  if(!raw) return;

  // Shift+Enter = nova linha
  if(!text){ chatInput.value=''; chatInput.style.height='auto'; }

  // valida credenciais
  const creds = requiredCreds();
  if(!creds) return;

  // mapeia comando
  const cmd = parseSlashCommand(raw);
  const msg = cmd || raw;

  // envia visual
  makeBubble('user', raw);
  history.push({role:'user', content: raw});
  const loadingRow = makeLoading();

  try{
    const resp = await fetch('/api/ai/chat', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        message: msg,
        usuario: creds.usuario,
        senha: creds.senha,
        comprador: COMPRADOR,
        history: history.slice(-8)
      })
    });

    loadingRow.remove();

    if(!resp.ok){
      makeBubble('assistant', `Falha ao contatar IA (${resp.status}).`);
      return;
    }

    const data = await resp.json();

    // Confirmação (alterar previsão etc.)
    if (data.confirmationRequired && data.action?.type === 'editar_previsao_pedido') {
      const { nunota, novaData } = data.action;
      const box = document.createElement('div');
      box.innerHTML = `
        ${nl2br(data.reply || 'Confirmar ação?')}
        <div class="mt-2 d-flex gap-2">
          <button class="btn btn-sm btn-primary" id="btnConfirmaPrev">Confirmar</button>
          <button class="btn btn-sm btn-outline-secondary" id="btnCancelaPrev">Cancelar</button>
        </div>
      `;
      const row = makeBubble('assistant', box);

      box.querySelector('#btnConfirmaPrev').addEventListener('click', async ()=>{
        box.querySelector('#btnConfirmaPrev').disabled = true;
        try{
          const r2 = await fetch('/api/ai/confirmar-previsao', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ usuario: creds.usuario, senha: creds.senha, nunota, novaData })
          });
          const j2 = await r2.json();
          makeBubble('assistant', j2.reply || (j2.ok ? 'Previsão atualizada.' : 'Não foi possível concluir.'));
        }catch(e){
          makeBubble('assistant', 'Erro ao confirmar atualização de previsão.');
        }
      });
      box.querySelector('#btnCancelaPrev').addEventListener('click', ()=> {
        makeBubble('assistant', 'Ação cancelada.');
      });
      return;
    }

    const reply = data.reply || 'Sem resposta no momento.';
    makeBubble('assistant', reply);
    history.push({role:'assistant', content: reply});

    if(data?.data?.table){
      makeBubble('assistant', tableFromData(data.data.table));
    }
    if(data?.data?.series){
      makeBubble('assistant', chartFromSeries(data.data.series));
    }

  }catch(err){
    loadingRow.remove();
    makeBubble('assistant', `Erro de rede. Tente novamente.`);
  }
}

// eventos
btnSend.addEventListener('click', ()=> sendChat());
chatInput.addEventListener('keydown', e=>{
  // auto-resize
  setTimeout(()=> {
    chatInput.style.height = 'auto';
    chatInput.style.height = Math.min(140, chatInput.scrollHeight) + 'px';
  }, 0);

  if(e.key==='Enter' && !e.shiftKey){
    e.preventDefault();
    sendChat();
  }
});
document.querySelectorAll('.suggestion').forEach(b=> b.addEventListener('click', ()=> sendChat(b.textContent)));

// mensagem inicial
makeBubble('assistant', 'Olá! Posso trazer <code>/necessidades</code>, <code>/criticos</code>, <code>/atrasados</code>, <code>/itens 101567</code> ou <code>/previsao 101567 10/09/2025</code>.');

/* ====================== Toolbar topo ======================= */
document.getElementById('aplicarComprador').addEventListener('click', ()=>{
  COMPRADOR = document.getElementById('compradorInput').value.toUpperCase().trim();
  localStorage.setItem('comprador', COMPRADOR);
  renderPedidos();
});
document.getElementById('btnRefresh').addEventListener('click', ()=>{
  // Aqui você pode “trocar” mocks por chamadas reais
  preencherKPIs(MOCK_KPIS);
  renderCharts(MOCK_SERIES);
  renderPedidos();
});

/* ===================== Inicialização ======================= */
document.addEventListener('DOMContentLoaded', ()=>{
  preencherKPIs(MOCK_KPIS);
  renderCharts(MOCK_SERIES);
  renderPedidos();
});
</script>
</body>
</html>
